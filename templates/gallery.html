<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Asset Builder</title>
    <style>
        body {
            background: #111;
            color: #eee;
            font-family: sans-serif;
            display: flex;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }

        /* Left: Library */
        #library {
            width: 60%;
            height: 100%;
            overflow-y: auto;
            border-right: 2px solid #333;
            padding: 20px;
            box-sizing: border-box;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(64px, 1fr));
            gap: 10px;
        }

        .cell {
            text-align: center;
            cursor: grab;
            padding: 5px;
            border: 1px solid #333;
            background: #222;
        }

        .cell:hover {
            background: #444;
        }

        .cell img {
            width: 48px;
            height: 48px;
            image-rendering: pixelated;
        }

        .cell .name {
            font-size: 10px;
            color: #aaa;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 60px;
            margin: 0 auto;
        }

        /* Right: Slots */
        #slots {
            width: 40%;
            height: 100%;
            overflow-y: auto;
            padding: 20px;
            background: #1a1a1a;
            box-sizing: border-box;
        }

        h2 {
            margin-top: 0;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }

        .slot-group {
            margin-bottom: 30px;
        }

        .slot-title {
            font-weight: bold;
            color: #0f0;
            margin-bottom: 5px;
        }

        .slot-target {
            background: #222;
            border: 2px dashed #555;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 15px;
            min-height: 50px;
            transition: background 0.2s;
        }

        .slot-target.drag-over {
            background: #333;
            border-color: #fff;
        }

        .slot-target img {
            width: 40px;
            height: 40px;
            image-rendering: pixelated;
            border: 1px solid #555;
            background: #000;
        }

        /* Messages */
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: #fff;
            padding: 10px 20px;
            border-radius: 5px;
            opacity: 0;
            transition: opacity 0.5s;
        }
    </style>
</head>

<body>

    <div id="library">
        <h2>Asset Library (Drag these)</h2>
        <input type="text" id="search-box" placeholder="Search assets..."
            style="width: 100%; padding: 10px; margin-bottom: 20px; box-sizing: border-box; background: #222; border: 1px solid #444; color: #fff;">
        <div class="grid" id="asset-grid">Loading...</div>
    </div>

    <div id="slots">
        <h2>Active Game Tiles (Drop here)</h2>
        <div id="slot-container"></div>
    </div>

    <div id="toast"></div>

    <script>
        const ROLES = [
            { id: 'wall_grey', label: 'Dungeon Wall' },
            { id: 'door', label: 'Dungeon Door' },
            { id: 'floor_wood', label: 'Town Floor (Wood)' },
            { id: 'grass', label: 'Town Grass' },
            { id: 'water', label: 'Town Water' },
            { id: 'tree', label: 'Town Tree' },
            { id: 'wall_house', label: 'Town House Wall' },
            { id: 'skeleton', label: 'Skeleton Enemy' },
            { id: 'player', label: 'Player Character' },
            { id: 'anvil', label: 'Anvil Prop' },
            { id: 'shelf', label: 'Shelf Prop' },
            { id: 'barrel', label: 'Town Barrel' },
            { id: 'crate', label: 'Town Crate' },
            { id: 'street_lamp', label: 'Street Lamp' },
            { id: 'fountain', label: 'Town Fountain' },
            { id: 'flower_pot', label: 'Flower Pot' },
            { id: 'signpost', label: 'Signpost' }
        ];

        function toast(msg, color = '#333') {
            const el = document.getElementById('toast');
            el.textContent = msg;
            el.style.background = color;
            el.style.opacity = 1;
            setTimeout(() => el.style.opacity = 0, 3000);
        }

        // Init Slots
        const slotContainer = document.getElementById('slot-container');
        ROLES.forEach(role => {
            const div = document.createElement('div');
            div.className = 'slot-group';
            div.innerHTML = `
                <div class="slot-title">${role.label}</div>
                <div class="slot-target" ondrop="drop(event, '${role.id}')" ondragover="allowDrop(event)">
                    <img src="/static/img/${role.id}.png?t=${Date.now()}" onerror="this.src='https://placehold.co/40x40/black/white?text=?'">
                    <span>Drop new image here</span>
                </div>
            `;
            slotContainer.appendChild(div);
        });

        // Fetch Library
        // Fetch Library
        let allFiles = [];

        async function loadLibrary() {
            const res = await fetch('/api/assets/list');
            const data = await res.json();
            allFiles = data.files;
            renderGrid(allFiles);
        }

        function renderGrid(files) {
            const grid = document.getElementById('asset-grid');
            grid.innerHTML = '';

            // Limit to 200 items for performance if needed, or pagination. 
            // But let's verify if pagination is needed later. Paging local array is fast.
            // For now render all (or top 500).

            files.slice(0, 500).forEach(file => {
                const div = document.createElement('div');
                div.className = 'cell';
                div.draggable = true;
                div.ondragstart = (e) => e.dataTransfer.setData("text", file);

                // Show relative path or just name? Asset library might have subfolders.
                // file is like "Tiny_Town/tile_0001.png"
                div.title = file; // Tooltip

                div.innerHTML = `
                    <img loading="lazy" src="/static/asset_library/${file}">
                    <div class="name">${file.split('/').pop()}</div>
                `;
                grid.appendChild(div);
            });
        }

        // Search Filter (Both Sides)
        document.getElementById('search-box').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();

            // 1. Filter Library (Left)
            const filtered = allFiles.filter(f => f.toLowerCase().includes(query));
            renderGrid(filtered);

            // 2. Filter Slots (Right)
            const slots = document.querySelectorAll('.slot-group');
            slots.forEach(grp => {
                const text = grp.textContent.toLowerCase();
                // Matches Title or content (label)
                if (text.includes(query)) {
                    grp.style.display = '';
                } else {
                    grp.style.display = 'none';
                }
            });
        });

        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        document.addEventListener('dragleave', (e) => {
            if (e.target.classList && e.target.classList.contains('slot-target')) {
                e.target.classList.remove('drag-over');
            }
        });

        async function drop(ev, roleId) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            const fileName = ev.dataTransfer.getData("text");

            const res = await fetch('/api/assets/assign', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ source: fileName, role: roleId })
            });
            const data = await res.json();

            if (data.error) {
                toast("Error: " + data.error, '#900');
                ev.currentTarget.style.borderColor = 'red';
            } else {
                toast("Saved " + roleId, '#090');
                // Refresh Image (with cache bust)
                const img = ev.currentTarget.querySelector('img');
                img.src = `/static/img/${roleId}.png?t=${Date.now()}`;
                ev.currentTarget.style.borderColor = '#0f0';
                setTimeout(() => ev.currentTarget.style.borderColor = '#555', 1000);
            }
        }

        loadLibrary();
    </script>
</body>

</html>